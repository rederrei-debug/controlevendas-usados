<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Controle de Vendas</title>
  <style>
    :root{
      --bg:#0b0f19;
      --card:#121a2a;
      --card2:#0f1626;
      --text:#e9eefc;
      --muted:#aab4d6;
      --line:#233052;
      --accent:#6d7cff;
      --accent2:#14b8a6;
      --danger:#ff4d6d;
      --warning:#ffb020;
      --ok:#29d17d;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1100px 700px at 20% -10%, rgba(109,124,255,.25), transparent 60%),
                  radial-gradient(900px 600px at 100% 0%, rgba(20,184,166,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 18px 14px 26px;
    }
    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 14px;
    }
    h1{
      margin:0;
      font-size: 22px;
      letter-spacing: .2px;
    }
    .sub{
      margin-top:6px;
      color:var(--muted);
      font-size: 13px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border:1px solid rgba(255,255,255,.08);
      border-radius: 999px;
      background: rgba(255,255,255,.03);
      box-shadow: var(--shadow);
      user-select:none;
      white-space: nowrap;
      font-size: 12px;
      color: var(--muted);
    }
    .dot{
      width:8px;height:8px;border-radius:99px;background: var(--ok);
      box-shadow: 0 0 0 4px rgba(41,209,125,.12);
    }

    .tabs{
      display:flex;
      gap:10px;
      padding: 8px;
      background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      border-radius: 999px;
      width: fit-content;
      box-shadow: var(--shadow);
      margin-bottom: 14px;
    }
    .tab{
      border:0;
      background: transparent;
      color: var(--muted);
      padding: 10px 14px;
      border-radius: 999px;
      cursor:pointer;
      font-weight: 600;
      letter-spacing: .2px;
    }
    .tab.active{
      background: linear-gradient(135deg, rgba(109,124,255,.35), rgba(20,184,166,.20));
      color: var(--text);
      border: 1px solid rgba(255,255,255,.10);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 14px;
    }
    @media (max-width: 860px){
      .grid{ grid-template-columns: 1fr; }
      header{ flex-direction: column; }
      .pill{ width: fit-content; }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(255,255,255,.07);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .card .hd h2{
      margin:0;
      font-size: 16px;
      letter-spacing: .2px;
    }
    .card .bd{
      padding: 14px;
    }
    .muted{ color: var(--muted); }

    .btns{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
    }
    button, .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 650;
      letter-spacing: .15px;
      box-shadow: 0 8px 18px rgba(0,0,0,.22);
      transition: transform .06s ease, background .15s ease;
      user-select:none;
    }
    button:active, .btn:active{ transform: translateY(1px); }
    .primary{
      background: linear-gradient(135deg, rgba(109,124,255,.55), rgba(109,124,255,.25));
      border-color: rgba(109,124,255,.55);
    }
    .teal{
      background: linear-gradient(135deg, rgba(20,184,166,.50), rgba(20,184,166,.18));
      border-color: rgba(20,184,166,.55);
    }
    .danger{
      background: linear-gradient(135deg, rgba(255,77,109,.55), rgba(255,77,109,.20));
      border-color: rgba(255,77,109,.65);
    }
    .ghost{
      background: transparent;
      border-color: rgba(255,255,255,.12);
      box-shadow:none;
    }

    .dash{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    .metric{
      background: rgba(0,0,0,.16);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      padding: 14px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .metric .label{
      color: var(--muted);
      font-size: 12px;
      margin-bottom: 6px;
    }
    .metric .value{
      font-size: 22px;
      font-weight: 800;
      letter-spacing: .2px;
    }

    .list{
      display:grid;
      gap: 10px;
    }
    .item{
      background: rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      padding: 12px;
    }
    .item-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
    }
    .item-name{
      font-weight: 800;
      letter-spacing: .2px;
    }
    .item-meta{
      margin-top:6px;
      color: var(--muted);
      font-size: 12px;
      display:flex;
      flex-wrap: wrap;
      gap: 10px 12px;
    }
    .chip{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      color: var(--muted);
    }
    .item-actions{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }
    .small{
      padding: 8px 10px;
      border-radius: 10px;
      font-weight: 750;
      font-size: 12px;
      box-shadow: none;
    }

    .hidden{ display:none !important; }

    /* Modal */
    .modal-backdrop{
      position: fixed;
      inset:0;
      background: rgba(0,0,0,.65);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px 14px;
      z-index: 50;
    }
    .modal{
      width: min(560px, 100%);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      box-shadow: 0 22px 70px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modal .mh{
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .modal .mh h3{
      margin:0;
      font-size: 15px;
      letter-spacing:.2px;
    }
    .modal .mb{
      padding: 14px;
    }

    label{
      display:block;
      margin: 10px 0 6px;
      color: var(--muted);
      font-size: 12px;
      font-weight: 700;
    }
    input, textarea, select{
      width: 100%;
      background: rgba(0,0,0,.20);
      color: var(--text);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 12px;
      padding: 11px 12px;
      outline:none;
      font-size: 14px;
    }
    textarea{ min-height: 88px; resize: vertical; }
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 520px){
      .row{ grid-template-columns: 1fr; }
    }
    .footnote{
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }
    .hr{
      height:1px;
      background: rgba(255,255,255,.08);
      margin: 10px 0;
    }
    .toast{
      position: fixed;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(0,0,0,.70);
      border:1px solid rgba(255,255,255,.14);
      color: var(--text);
      display:none;
      z-index: 60;
      font-weight: 700;
      letter-spacing: .2px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Controle de Vendas</h1>
        <div class="sub">Produtos usados • Estoque • Lucro • Histórico</div>
      </div>
      <div class="pill" id="pillStatus">
        <span class="dot" id="dot"></span>
        <span id="statusText">Pronto</span>
      </div>
    </header>

    <div class="tabs" role="tablist">
      <button class="tab active" data-tab="estoque">Estoque</button>
      <button class="tab" data-tab="vender">Vender</button>
      <button class="tab" data-tab="historico">Histórico</button>
    </div>

    <div class="grid">
      <!-- Coluna principal -->
      <div class="card" id="cardMain">
        <div class="hd">
          <h2 id="mainTitle">Estoque</h2>
          <div class="btns">
            <button class="primary" id="btnAdd">+ Cadastrar</button>
            <button class="ghost" id="btnBackup">Backup</button>
            <button class="danger" id="btnClear">Limpar</button>
          </div>
        </div>
        <div class="bd">
          <div class="muted" id="mainDesc">Cadastre seus produtos e acompanhe o estoque.</div>
          <div class="hr"></div>

          <div id="viewEstoque">
            <div class="list" id="listEstoque"></div>
            <div class="footnote">
              • O app salva automaticamente.<br />
              • No Kodular, a sincronização é feita via TinyDB (WebViewString).
            </div>
          </div>

          <div id="viewVender" class="hidden">
            <div class="row">
              <div>
                <label>Produto</label>
                <select id="sellProduct"></select>
              </div>
              <div>
                <label>Quantidade</label>
                <input id="sellQty" type="number" min="1" step="1" inputmode="numeric" />
              </div>
            </div>
            <div class="row">
              <div>
                <label>Preço de venda (R$)</label>
                <input id="sellPrice" type="number" min="0" step="0.01" inputmode="decimal" />
              </div>
              <div>
                <label>Comprador / Observações</label>
                <input id="sellBuyer" type="text" />
              </div>
            </div>
            <div style="margin-top:12px" class="btns">
              <button class="teal" id="btnConfirmSale">Confirmar venda</button>
              <button class="ghost" id="btnGoEstoque2">Voltar ao estoque</button>
            </div>
            <div class="footnote" id="sellHint"></div>
          </div>

          <div id="viewHistorico" class="hidden">
            <div class="list" id="listHistorico"></div>
          </div>

        </div>
      </div>

      <!-- Dashboard -->
      <div class="card">
        <div class="hd">
          <h2>Dashboard</h2>
        </div>
        <div class="bd">
          <div class="muted" style="margin-bottom:10px">Resumo geral do seu controle.</div>
          <div class="dash">
            <div class="metric">
              <div>
                <div class="label">Itens em estoque</div>
                <div class="value" id="mStock">0</div>
              </div>
              <span class="chip">Unidades</span>
            </div>
            <div class="metric">
              <div>
                <div class="label">Lucro (total)</div>
                <div class="value" id="mProfit">R$ 0,00</div>
              </div>
              <span class="chip">Acumulado</span>
            </div>
            <div class="metric">
              <div>
                <div class="label">Vendas (quantidade)</div>
                <div class="value" id="mSales">0</div>
              </div>
              <span class="chip">Unidades</span>
            </div>
          </div>
        </div>
      </div>
    </div><!-- grid -->
  </div><!-- wrap -->

  <!-- Modal Produto -->
  <div class="modal-backdrop" id="modalProduct">
    <div class="modal">
      <div class="mh">
        <h3 id="productTitle">Cadastrar produto</h3>
        <button class="ghost small" id="closeProduct">Fechar</button>
      </div>
      <div class="mb">
        <input type="hidden" id="pId" />
        <label>Nome do produto</label>
        <input id="pName" type="text" />

        <div class="row">
          <div>
            <label>Preço de custo (R$)</label>
            <input id="pCost" type="number" min="0" step="0.01" inputmode="decimal" />
          </div>
          <div>
            <label>Preço de venda sugerido (R$)</label>
            <input id="pPrice" type="number" min="0" step="0.01" inputmode="decimal" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Quantidade</label>
            <input id="pQty" type="number" min="0" step="1" inputmode="numeric" />
          </div>
          <div>
            <label>&nbsp;</label>
            <div class="footnote" style="margin-top:2px">Dica: você pode editar depois.</div>
          </div>
        </div>

        <label>Observações</label>
        <textarea id="pNotes"></textarea>

        <div style="margin-top:12px" class="btns">
          <button class="primary" id="saveProduct">Salvar produto</button>
          <button class="ghost" id="cancelProduct">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Backup -->
  <div class="modal-backdrop" id="modalBackup">
    <div class="modal">
      <div class="mh">
        <h3>Backup</h3>
        <button class="ghost small" id="closeBackup">Fechar</button>
      </div>
      <div class="mb">
        <div class="footnote">
          Copie esse texto e guarde. Se precisar restaurar, cole no campo abaixo e clique em “Restaurar”.
        </div>
        <label>Backup (Base64)</label>
        <textarea id="backupText" spellcheck="false"></textarea>
        <div style="margin-top:12px" class="btns">
          <button class="ghost" id="btnCopyB64">Copiar</button>
          <button class="teal" id="btnRestoreB64">Restaurar</button>
        </div>
        <div class="footnote">
          * Esse Base64 é o mesmo que o Kodular salva no TinyDB.
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/* =========================
   Estado + Persistência
========================= */
const STORAGE_KEY = "cvusados_state_v1";

let state = {
  v: 1,
  updatedAt: Date.now(),
  products: [],
  sales: []
};

let lastSyncedB64 = "";
let receivedKodularData = false;
let applyingExternal = false;

function now(){ return Date.now(); }
function uid(){
  return Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
}
function moneyBRL(n){
  const v = Number(n || 0);
  return v.toLocaleString("pt-BR", { style:"currency", currency:"BRL" });
}
function toNumber(v){
  const n = Number(String(v ?? "").replace(",", "."));
  return Number.isFinite(n) ? n : 0;
}

/* Base64 seguro p/ UTF-8 */
function b64EncodeUnicode(str){
  const bytes = new TextEncoder().encode(str);
  let bin = "";
  bytes.forEach(b => bin += String.fromCharCode(b));
  return btoa(bin);
}
function b64DecodeUnicode(b64){
  const bin = atob(b64);
  const bytes = Uint8Array.from(bin, c => c.charCodeAt(0));
  return new TextDecoder().decode(bytes);
}
function stateToB64(s){
  return b64EncodeUnicode(JSON.stringify(s));
}
function b64ToState(b64){
  const json = b64DecodeUnicode(b64);
  return JSON.parse(json);
}

function loadFromLocalStorage(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return false;
    const parsed = JSON.parse(raw);
    if(!parsed || !parsed.products || !parsed.sales) return false;
    state = parsed;
    return true;
  }catch(e){
    return false;
  }
}

function saveToLocalStorage(){
  try{
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }catch(e){}
}

/* Envia Base64 pro Kodular via WebViewString */
function syncToKodular(){
  try{
    if(applyingExternal) return;
    const b64 = stateToB64(state);
    if(b64 === lastSyncedB64) return;
    lastSyncedB64 = b64;

    // Backup textarea
    const bt = document.getElementById("backupText");
    if(bt) bt.value = b64;

    // Kodular / App Inventor bridge
    if(window.AppInventor && typeof window.AppInventor.setWebViewString === "function"){
      window.AppInventor.setWebViewString(b64);
      setStatus("Salvo no TinyDB", true);
    } else {
      // Web: só mostra salvo local
      setStatus("Salvo local", true);
    }
  }catch(e){}
}

function setStatus(text, ok){
  const st = document.getElementById("statusText");
  const dot = document.getElementById("dot");
  if(st) st.textContent = text;
  if(dot){
    dot.style.background = ok ? getComputedStyle(document.documentElement).getPropertyValue("--ok") : getComputedStyle(document.documentElement).getPropertyValue("--warning");
  }
}

function commit(reason){
  state.updatedAt = now();
  saveToLocalStorage();
  syncToKodular();
}

/* =========================
   API para o Kodular
   (Evaluate JS -> window.loadFromKodularB64("...."))
========================= */
window.loadFromKodularB64 = function(b64){
  try{
    if(!b64 || typeof b64 !== "string") return false;
    receivedKodularData = true;
    applyingExternal = true;

    const incoming = b64ToState(b64);
    if(incoming && incoming.products && incoming.sales){
      state = incoming;
      saveToLocalStorage(); // mantém também no web
      renderAll();
      // atualiza backup box e evita eco
      lastSyncedB64 = b64;
      const bt = document.getElementById("backupText");
      if(bt) bt.value = b64;
      toast("Dados restaurados");
      setStatus("Restaurado", true);
      return true;
    }
    return false;
  }catch(e){
    toast("Backup inválido");
    return false;
  }finally{
    applyingExternal = false;
  }
};

// útil pra debug
window.getCurrentB64 = () => stateToB64(state);

/* =========================
   UI / Render
========================= */
const $ = (sel) => document.querySelector(sel);

const tabs = Array.from(document.querySelectorAll(".tab"));
const mainTitle = $("#mainTitle");
const mainDesc = $("#mainDesc");

const viewEstoque = $("#viewEstoque");
const viewVender = $("#viewVender");
const viewHistorico = $("#viewHistorico");

const listEstoque = $("#listEstoque");
const listHistorico = $("#listHistorico");

const mStock = $("#mStock");
const mProfit = $("#mProfit");
const mSales = $("#mSales");

const btnAdd = $("#btnAdd");
const btnBackup = $("#btnBackup");
const btnClear = $("#btnClear");

const modalProduct = $("#modalProduct");
const modalBackup = $("#modalBackup");

const sellProduct = $("#sellProduct");
const sellQty = $("#sellQty");
const sellPrice = $("#sellPrice");
const sellBuyer = $("#sellBuyer");
const btnConfirmSale = $("#btnConfirmSale");
const btnGoEstoque2 = $("#btnGoEstoque2");
const sellHint = $("#sellHint");

function toast(msg){
  const t = $("#toast");
  if(!t) return;
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(toast._timer);
  toast._timer = setTimeout(()=>{ t.style.display="none"; }, 1800);
}

function setActiveTab(name){
  tabs.forEach(b => b.classList.toggle("active", b.dataset.tab === name));

  viewEstoque.classList.toggle("hidden", name !== "estoque");
  viewVender.classList.toggle("hidden", name !== "vender");
  viewHistorico.classList.toggle("hidden", name !== "historico");

  if(name === "estoque"){
    mainTitle.textContent = "Estoque";
    mainDesc.textContent = "Cadastre seus produtos e acompanhe o estoque.";
    btnAdd.classList.remove("hidden");
    btnBackup.classList.remove("hidden");
    btnClear.classList.remove("hidden");
  }
  if(name === "vender"){
    mainTitle.textContent = "Vender";
    mainDesc.textContent = "Registre vendas e acompanhe seu lucro.";
    btnAdd.classList.add("hidden");
    btnBackup.classList.add("hidden");
    btnClear.classList.add("hidden");
    refreshSellForm();
  }
  if(name === "historico"){
    mainTitle.textContent = "Histórico";
    mainDesc.textContent = "Veja todas as vendas registradas.";
    btnAdd.classList.add("hidden");
    btnBackup.classList.remove("hidden");
    btnClear.classList.remove("hidden");
  }
}

tabs.forEach(btn=>{
  btn.addEventListener("click", ()=> setActiveTab(btn.dataset.tab));
});

function calcMetrics(){
  const stockUnits = state.products.reduce((a,p)=> a + (Number(p.qty)||0), 0);
  const totalProfit = state.sales.reduce((a,s)=> a + (Number(s.profit)||0), 0);
  const salesUnits = state.sales.reduce((a,s)=> a + (Number(s.qty)||0), 0);

  mStock.textContent = stockUnits;
  mProfit.textContent = moneyBRL(totalProfit);
  mSales.textContent = salesUnits;
}

function renderEstoque(){
  listEstoque.innerHTML = "";
  if(state.products.length === 0){
    listEstoque.innerHTML = `<div class="item">
      <div class="item-name">Nenhum produto ainda.</div>
      <div class="item-meta"><span class="chip">Clique em “+ Cadastrar” para começar</span></div>
    </div>`;
    return;
  }

  // ordena por nome
  const products = [...state.products].sort((a,b)=> (a.name||"").localeCompare(b.name||""));
  for(const p of products){
    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `
      <div class="item-top">
        <div>
          <div class="item-name">${escapeHtml(p.name || "")}</div>
          <div class="item-meta">
            <span class="chip">Qtd: <b style="color:var(--text)">${Number(p.qty)||0}</b></span>
            <span class="chip">Custo: <b style="color:var(--text)">${moneyBRL(p.cost)}</b></span>
            <span class="chip">Venda: <b style="color:var(--text)">${moneyBRL(p.price)}</b></span>
          </div>
          ${p.notes ? `<div class="footnote" style="margin-top:8px">${escapeHtml(p.notes)}</div>` : ``}
        </div>
        <div class="item-actions">
          <button class="small teal" data-act="sell">Vender</button>
          <button class="small" data-act="edit">Editar</button>
          <button class="small danger" data-act="del">Excluir</button>
        </div>
      </div>
    `;
    el.querySelector('[data-act="sell"]').addEventListener("click", ()=>{
      setActiveTab("vender");
      sellProduct.value = p.id;
      refreshSellForm(true);
    });
    el.querySelector('[data-act="edit"]').addEventListener("click", ()=> openProductModal(p));
    el.querySelector('[data-act="del"]').addEventListener("click", ()=> deleteProduct(p.id));
    listEstoque.appendChild(el);
  }
}

function renderHistorico(){
  listHistorico.innerHTML = "";
  if(state.sales.length === 0){
    listHistorico.innerHTML = `<div class="item">
      <div class="item-name">Nenhuma venda registrada.</div>
      <div class="item-meta"><span class="chip">Use a aba “Vender”</span></div>
    </div>`;
    return;
  }

  const sales = [...state.sales].sort((a,b)=> (b.date||0) - (a.date||0));
  for(const s of sales){
    const dt = new Date(s.date || Date.now());
    const dateStr = dt.toLocaleString("pt-BR");
    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `
      <div class="item-top">
        <div>
          <div class="item-name">${escapeHtml(s.productName || "Venda")}</div>
          <div class="item-meta">
            <span class="chip">Qtd: <b style="color:var(--text)">${Number(s.qty)||0}</b></span>
            <span class="chip">Preço: <b style="color:var(--text)">${moneyBRL(s.price)}</b></span>
            <span class="chip">Lucro: <b style="color:var(--text)">${moneyBRL(s.profit)}</b></span>
            <span class="chip">${dateStr}</span>
          </div>
          ${s.buyer ? `<div class="footnote" style="margin-top:8px">${escapeHtml(s.buyer)}</div>` : ``}
        </div>
        <div class="item-actions">
          <button class="small danger" data-act="del">Remover</button>
        </div>
      </div>
    `;
    el.querySelector('[data-act="del"]').addEventListener("click", ()=> deleteSale(s.id));
    listHistorico.appendChild(el);
  }
}

function renderAll(){
  calcMetrics();
  renderEstoque();
  renderHistorico();
  refreshSellOptions();
}

function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, (m)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

/* =========================
   Produto: CRUD
========================= */
function openProductModal(p){
  $("#pId").value = p?.id || "";
  $("#pName").value = p?.name || "";
  $("#pCost").value = (p?.cost ?? "");
  $("#pPrice").value = (p?.price ?? "");
  $("#pQty").value = (p?.qty ?? 1);
  $("#pNotes").value = p?.notes || "";
  $("#productTitle").textContent = p ? "Editar produto" : "Cadastrar produto";
  modalProduct.style.display = "flex";
  setTimeout(()=> $("#pName").focus(), 50);
}

function closeProductModal(){
  modalProduct.style.display = "none";
}

function upsertProduct(){
  const id = $("#pId").value || uid();
  const name = $("#pName").value.trim();
  const cost = toNumber($("#pCost").value);
  const price = toNumber($("#pPrice").value);
  const qty = Math.max(0, Math.floor(toNumber($("#pQty").value)));
  const notes = $("#pNotes").value.trim();

  if(!name){
    toast("Informe o nome do produto");
    $("#pName").focus();
    return;
  }

  const idx = state.products.findIndex(p=> p.id === id);
  const obj = { id, name, cost, price, qty, notes, updatedAt: now() };

  if(idx >= 0){
    state.products[idx] = { ...state.products[idx], ...obj };
    toast("Produto atualizado");
  }else{
    state.products.push({ ...obj, createdAt: now() });
    toast("Produto cadastrado");
  }

  closeProductModal();
  renderAll();
  commit("product");
}

function deleteProduct(id){
  const p = state.products.find(x=>x.id===id);
  if(!p) return;
  if(!confirm(`Excluir "${p.name}"?`)) return;

  // remove também vendas relacionadas? (mantém histórico, então não apaga vendas)
  state.products = state.products.filter(x=>x.id!==id);
  renderAll();
  commit("deleteProduct");
  toast("Produto removido");
}

btnAdd.addEventListener("click", ()=> openProductModal(null));
$("#closeProduct").addEventListener("click", closeProductModal);
$("#cancelProduct").addEventListener("click", closeProductModal);
$("#saveProduct").addEventListener("click", upsertProduct);

modalProduct.addEventListener("click", (e)=>{
  if(e.target === modalProduct) closeProductModal();
});

/* =========================
   Vender
========================= */
function refreshSellOptions(){
  const current = sellProduct.value;
  sellProduct.innerHTML = "";
  const products = [...state.products].filter(p=> (Number(p.qty)||0) > 0)
    .sort((a,b)=> (a.name||"").localeCompare(b.name||""));
  if(products.length === 0){
    sellProduct.innerHTML = `<option value="">(Sem estoque)</option>`;
  }else{
    for(const p of products){
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.textContent = `${p.name} (Qtd: ${Number(p.qty)||0})`;
      sellProduct.appendChild(opt);
    }
  }
  // tenta manter seleção
  if(current && products.some(p=>p.id===current)) sellProduct.value = current;
}

function refreshSellForm(keepQty){
  refreshSellOptions();
  const id = sellProduct.value;
  const p = state.products.find(x=>x.id===id);
  if(!p){
    sellQty.value = "";
    sellPrice.value = "";
    sellBuyer.value = "";
    sellHint.textContent = "Você precisa ter estoque para registrar uma venda.";
    btnConfirmSale.disabled = true;
    return;
  }
  btnConfirmSale.disabled = false;
  if(!keepQty) sellQty.value = 1;
  sellPrice.value = p.price ?? 0;
  sellHint.textContent = `Em estoque: ${Number(p.qty)||0} • Custo: ${moneyBRL(p.cost)} • Venda sugerida: ${moneyBRL(p.price)}`;
}

sellProduct.addEventListener("change", ()=> refreshSellForm(false));

function confirmSale(){
  const id = sellProduct.value;
  const p = state.products.find(x=>x.id===id);
  if(!p){ toast("Selecione um produto"); return; }

  const qty = Math.max(1, Math.floor(toNumber(sellQty.value)));
  if(qty > (Number(p.qty)||0)){
    toast("Quantidade maior que o estoque");
    return;
  }

  const price = Math.max(0, toNumber(sellPrice.value));
  const buyer = sellBuyer.value.trim();

  const profit = (price - toNumber(p.cost)) * qty;

  // baixa estoque
  p.qty = (Number(p.qty)||0) - qty;
  p.updatedAt = now();

  // registra venda
  state.sales.push({
    id: uid(),
    productId: p.id,
    productName: p.name,
    qty,
    price,
    buyer,
    date: now(),
    profit
  });

  renderAll();
  commit("sale");
  toast("Venda registrada");
  sellBuyer.value = "";
  refreshSellForm(false);
}

btnConfirmSale.addEventListener("click", confirmSale);
btnGoEstoque2.addEventListener("click", ()=> setActiveTab("estoque"));

function deleteSale(id){
  if(!confirm("Remover essa venda do histórico?")) return;
  state.sales = state.sales.filter(s=>s.id!==id);
  renderAll();
  commit("deleteSale");
  toast("Venda removida");
}

/* =========================
   Backup / Limpar
========================= */
function openBackup(){
  $("#backupText").value = stateToB64(state);
  modalBackup.style.display = "flex";
}
function closeBackup(){
  modalBackup.style.display = "none";
}
btnBackup.addEventListener("click", openBackup);
$("#closeBackup").addEventListener("click", closeBackup);
modalBackup.addEventListener("click", (e)=>{
  if(e.target === modalBackup) closeBackup();
});

$("#btnCopyB64").addEventListener("click", async ()=>{
  const text = $("#backupText").value.trim();
  if(!text){ toast("Nada para copiar"); return; }
  try{
    await navigator.clipboard.writeText(text);
    toast("Copiado!");
  }catch(e){
    $("#backupText").select();
    document.execCommand("copy");
    toast("Copiado!");
  }
});

$("#btnRestoreB64").addEventListener("click", ()=>{
  const b64 = $("#backupText").value.trim();
  if(!b64){ toast("Cole um Base64"); return; }
  if(!confirm("Restaurar esse backup? Isso vai substituir os dados atuais.")) return;
  const ok = window.loadFromKodularB64(b64); // reaproveita a função (aplica + render)
  if(ok){
    closeBackup();
    commit("restore"); // garante que sincroniza também
  }
});

btnClear.addEventListener("click", ()=>{
  if(!confirm("Isso vai apagar TUDO (estoque + histórico). Continuar?")) return;
  state.products = [];
  state.sales = [];
  renderAll();
  commit("clear");
  toast("Dados apagados");
});

/* =========================
   Inicialização
========================= */
function init(){
  // 1) tenta carregar do localStorage (web)
  loadFromLocalStorage();
  renderAll();

  // 2) prepara Base64 no backup
  $("#backupText").value = stateToB64(state);

  // 3) MUITO IMPORTANTE:
  //    não mandar WebViewString logo no início, pra não sobrescrever o TinyDB antes de você restaurar.
  //    se o Kodular chamar loadFromKodularB64 em até ~2s, ele ganha prioridade.
  setTimeout(()=>{
    if(!receivedKodularData){
      // se não veio nada do Kodular, sincroniza o que está aqui (localStorage/estado atual)
      syncToKodular();
      setStatus("Pronto", true);
    }
  }, 2000);

  setActiveTab("estoque");
}

init();
</script>
</body>
</html>
