<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Controle de Vendas</title>

<style>
:root{
  --bg:#f4f6f9;
  --card:#ffffff;
  --primary:#2563eb;
  --success:#16a34a;
  --danger:#dc2626;
  --warning:#f59e0b;
  --text:#111827;
  --border:#e5e7eb;
  --muted:#6b7280;
}

*{box-sizing:border-box}
html,body{height:100%}

body{
  margin:0;
  font-family:Segoe UI,Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
  -webkit-tap-highlight-color: transparent;
}

header{
  padding:18px 16px;
  text-align:center;
  font-size:22px;
  font-weight:800;
  background:var(--primary);
  color:#fff;
}

/* NAV (2x2 no celular) */
nav{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  padding:14px 12px;
  max-width:900px;
  margin:auto;
}

nav button{
  flex:1 1 calc(50% - 10px);
  padding:14px;
  border-radius:22px;
  border:none;
  background:var(--primary);
  color:#fff;
  font-weight:800;
  font-size:15px;
  touch-action: manipulation;
}

.container{
  max-width:900px;
  margin:auto;
  padding:12px;
}

.card{
  background:var(--card);
  border-radius:20px;
  padding:16px;
  border:1px solid var(--border);
  margin-bottom:12px;
}

.hidden{display:none}

input,select,textarea{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:1px solid var(--border);
  margin-bottom:10px;
  font-size:16px;
  background:#fff;
}

textarea{resize:vertical}

button.action{
  width:100%;
  padding:12px;
  border-radius:14px;
  background:var(--primary);
  color:#fff;
  border:none;
  font-weight:800;
  font-size:16px;
  touch-action: manipulation;
}

/* DASHBOARD */
.dashboard{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:12px;
}

.stat{
  background:#f9fafb;
  padding:16px;
  border-radius:18px;
  border:1px solid var(--border);
}

.stat .label{
  font-weight:700;
  color:var(--muted);
  font-size:13px;
}

.stat span{
  display:block;
  font-size:30px;
  font-weight:900;
  margin-top:6px;
}

.stat:nth-child(1) span{color:var(--warning)}
.stat:nth-child(2) span{color:var(--primary)}
.stat:nth-child(3) span{color:var(--success)}

/* CADASTRO FOTO */
.foto-row{
  display:grid;
  grid-template-columns:110px 1fr;
  gap:12px;
  align-items:stretch;
  margin-bottom:10px;
}

.foto-preview{
  border:1px dashed var(--border);
  border-radius:16px;
  background:#f9fafb;
  display:flex;
  align-items:center;
  justify-content:center;
  position:relative;
  overflow:hidden;
  min-height:110px;
}

.foto-preview img{
  width:100%;
  height:100%;
  object-fit:cover;
  display:none;
}

.foto-preview .hint{
  color:var(--muted);
  font-size:12px;
  text-align:center;
  padding:8px;
}

.foto-preview .btn-clear{
  position:absolute;
  top:8px;
  right:8px;
  width:32px;
  height:32px;
  border:none;
  border-radius:10px;
  background:rgba(0,0,0,.55);
  color:#fff;
  font-size:16px;
  display:none;
  cursor:pointer;
}

.foto-btns{
  display:flex;
  gap:10px;
  flex-direction:column;
}

.foto-btns button{
  padding:12px;
  border-radius:14px;
  border:none;
  font-weight:800;
  font-size:15px;
  color:#fff;
  background:#111827;
  touch-action: manipulation;
}

.foto-btns button.secondary{
  background:#1f2937;
}

/* VENDA */
.venda-top{
  padding:14px;
}
.venda-top .sub{
  font-size:13px;
  color:var(--muted);
  margin:2px 0 10px;
  font-weight:600;
}

.produto{
  position:relative;
  display:grid;
  grid-template-columns:90px 1fr;
  gap:12px;
  border:1px solid var(--border);
  border-radius:18px;
  padding:14px;
  margin-bottom:12px;
  background:#fff;
}

.produto img{
  width:90px;
  height:90px;
  object-fit:cover;
  border-radius:14px;
  background:#e5e7eb;
}

/* Lixeira (excluir do estoque) */
.btn-lixeira{
  position:absolute;
  top:10px;
  right:10px;
  width:36px;height:36px;
  border:none;
  border-radius:12px;
  background:#fee2e2;
  color:#991b1b;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  touch-action: manipulation;
}
.btn-lixeira svg{width:18px;height:18px}

small{color:var(--muted)}

/* HIST√ìRICO */
.historico-item{
  border:1px solid var(--border);
  border-radius:18px;
  padding:12px;
  margin-bottom:12px;
  background:#fff;
}
.historico-header{
  display:grid;
  grid-template-columns:64px 1fr 86px 26px;
  align-items:center;
  gap:6px;
}
.historico-header img{
  width:64px;
  height:64px;
  object-fit:cover;
  border-radius:14px;
  background:#e5e7eb;
}
.seta{
  font-size:18px;
  text-align:center;
  cursor:pointer;
}
.historico-detalhes{
  margin-top:10px;
  padding-top:10px;
  border-top:1px dashed var(--border);
  display:none;
}

@media (max-width: 520px){
  header{padding:16px 14px;font-size:20px}
  .container{padding:12px}
  .dashboard{grid-template-columns:1fr}
  .stat span{font-size:34px}
}
</style>
</head>

<body>
<header>üí∞ Controle de Vendas</header>

<nav>
  <button onclick="mostrar('dashboard')">Dashboard</button>
  <button onclick="mostrar('cadastro')">Cadastrar</button>
  <button onclick="mostrar('venda')">Vender</button>
  <button onclick="mostrar('historico')">Hist√≥rico</button>
</nav>

<div class="container">

  <!-- DASHBOARD -->
  <div id="dashboard" class="card">
    <div class="dashboard">
      <div class="stat"><div class="label">Produtos em estoque</div><span id="qtd">0</span></div>
      <div class="stat"><div class="label">Valor em estoque</div><span>R$ <span id="valorEstoque">0.00</span></span></div>
      <div class="stat"><div class="label">Lucro total</div><span>R$ <span id="lucro">0.00</span></span></div>
    </div>
  </div>

  <!-- CADASTRO -->
  <div id="cadastro" class="card hidden">
    <input id="nomeProduto" placeholder="Nome do produto" autocomplete="off" />
    <input id="valorCompra" type="number" placeholder="Valor de compra" inputmode="decimal" />

    <div class="foto-row">
      <div class="foto-preview" id="fotoPreview">
        <div class="hint" id="fotoHint">Sem foto (opcional)</div>
        <button class="btn-clear" id="btnClearFoto" type="button" onclick="removerFoto()">‚úï</button>
        <img id="fotoImg" alt="Foto do produto" />
      </div>

      <div class="foto-btns">
        <button type="button" onclick="tirarFoto()">üì∏ Tirar foto</button>
        <button type="button" class="secondary" onclick="abrirGaleria()">üñºÔ∏è Galeria</button>
      </div>
    </div>

    <button class="action" id="btnCadastrar" onclick="cadastrar()">Cadastrar Produto</button>
  </div>

  <!-- VENDA -->
  <div id="venda" class="hidden"></div>

  <!-- HIST√ìRICO -->
  <div id="historico" class="card hidden">
    <select id="filtroMes" onchange="atualizarHistorico()">
      <option value="">Todos os meses</option>
      <option value="0">Janeiro</option><option value="1">Fevereiro</option><option value="2">Mar√ßo</option>
      <option value="3">Abril</option><option value="4">Maio</option><option value="5">Junho</option>
      <option value="6">Julho</option><option value="7">Agosto</option><option value="8">Setembro</option>
      <option value="9">Outubro</option><option value="10">Novembro</option><option value="11">Dezembro</option>
    </select>
    <div id="historicoLista"></div>
  </div>

</div>

<script>
/* ===================== STATE ===================== */
let estoque = [];
let historico = [];
let lucroTotal = 0;

let imagemTemp = null;        // aqui pode ser file:///... (Kodular) OU base64 (browser)
let saveTimer = null;
let vendaFiltro = "";

/* ===================== UTIL ===================== */
function uid(prefix="id"){
  return `${prefix}_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,8)}`;
}
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* ========= helpers base64 (unicode safe) ========= */
function toB64Unicode(str){
  const bytes = new TextEncoder().encode(str);
  let bin = "";
  bytes.forEach(b => bin += String.fromCharCode(b));
  return btoa(bin);
}
function fromB64Unicode(b64){
  const bin = atob(b64);
  const bytes = Uint8Array.from(bin, c => c.charCodeAt(0));
  return new TextDecoder().decode(bytes);
}

/* ========= comunica√ß√£o com Kodular ========= */
function isKodular(){
  return !!(window.AppInventor && typeof window.AppInventor.setWebViewString === "function");
}

/* manda comando para o Kodular */
function sendCmd(cmd){
  if(isKodular()){
    window.AppInventor.setWebViewString(cmd);
  }else{
    alert("Este bot√£o funciona no app (Kodular). No navegador, use upload manual se quiser.");
  }
}

function snapshotObj(updatedAt){
  return { v: 2, updatedAt: updatedAt || Date.now(), estoque, historico, lucroTotal };
}
function exportSnapshotB64(updatedAt){
  return toB64Unicode(JSON.stringify(snapshotObj(updatedAt)));
}
function enviarParaKodularDebounced(updatedAt){
  if(!isKodular()) return;
  clearTimeout(saveTimer);
  saveTimer = setTimeout(() => {
    try{
      window.AppInventor.setWebViewString(exportSnapshotB64(updatedAt));
    }catch(e){
      console.log("Falha ao enviar para Kodular:", e);
    }
  }, 550);
}

/* Fun√ß√£o chamada pelo Kodular via EvaluateJS */
window.loadFromKodularB64 = function(b64){
  try{
    if(!b64) return;

    const json = fromB64Unicode(b64);
    const data = JSON.parse(json);
    if(!data || typeof data !== "object") return;

    const remoteUpdated = Number(data.updatedAt || 0);
    const localUpdated  = Number(localStorage.getItem("updatedAt") || 0);

    if(localUpdated && remoteUpdated && remoteUpdated <= localUpdated) return;

    estoque = Array.isArray(data.estoque) ? data.estoque : [];
    historico = Array.isArray(data.historico) ? data.historico : [];
    lucroTotal = Number(data.lucroTotal || 0);

    try{
      localStorage.setItem("estoque", JSON.stringify(estoque));
      localStorage.setItem("historico", JSON.stringify(historico));
      localStorage.setItem("lucroTotal", String(lucroTotal));
      localStorage.setItem("updatedAt", String(remoteUpdated || Date.now()));
    }catch(e){}

    atualizarDashboard();
    atualizarHistorico();
    if(!document.getElementById("venda").classList.contains("hidden")) renderVenda();
  }catch(e){
    console.log("loadFromKodularB64 erro:", e);
  }
};

/* ===================== STORAGE ===================== */
function salvarDados(){
  const updatedAt = Date.now();

  try{
    localStorage.setItem("estoque", JSON.stringify(estoque));
    localStorage.setItem("historico", JSON.stringify(historico));
    localStorage.setItem("lucroTotal", String(lucroTotal));
    localStorage.setItem("updatedAt", String(updatedAt));
  }catch(e){
    console.log("localStorage erro:", e);
  }

  enviarParaKodularDebounced(updatedAt);
}

function carregarDados(){
  try{
    estoque = JSON.parse(localStorage.getItem("estoque")) || [];
    historico = JSON.parse(localStorage.getItem("historico")) || [];
    lucroTotal = parseFloat(localStorage.getItem("lucroTotal")) || 0;
  }catch(e){
    estoque = [];
    historico = [];
    lucroTotal = 0;
  }
  atualizarDashboard();
  atualizarHistorico();
}

/* ===================== NAV ===================== */
function mostrar(id){
  if(id !== "venda"){
    vendaFiltro = "";
    const b = document.getElementById("buscaVenda");
    if(b) b.value = "";
  }

  document.querySelectorAll('.card,#venda').forEach(e => e.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');

  if(id === "venda") renderVenda();
}

/* ===================== FOTO (KODULAR) ===================== */
function setPreviewFoto(src){
  const img = document.getElementById("fotoImg");
  const hint = document.getElementById("fotoHint");
  const btn = document.getElementById("btnClearFoto");

  if(src){
    img.src = src;
    img.style.display = "block";
    hint.style.display = "none";
    btn.style.display = "block";
  }else{
    img.removeAttribute("src");
    img.style.display = "none";
    hint.style.display = "block";
    btn.style.display = "none";
  }
}

function removerFoto(){
  imagemTemp = null;
  setPreviewFoto(null);
}

/* Bot√µes */
function tirarFoto(){
  // chama Kodular (Camera1.TakePicture via blocks)
  sendCmd("CMD:CAMERA");
}

function abrirGaleria(){
  // chama Kodular (ImagePicker.Open via blocks)
  sendCmd("CMD:GALERIA");
}

/* Kodular vai chamar isso por EvaluateJS ap√≥s tirar foto */
window.onKodularCamera = function(path){
  try{
    if(!path) return;
    // normaliza
    let p = String(path);
    if(!p.startsWith("file:") && !p.startsWith("content:")){
      // se vier como /storage/emulated...
      if(p.startsWith("/")) p = "file://" + p;
      else p = "file:///" + p;
    }
    imagemTemp = p;
    setPreviewFoto(p);
  }catch(e){
    console.log("onKodularCamera erro:", e);
  }
};

/* Kodular vai chamar isso por EvaluateJS ap√≥s escolher da galeria */
window.onKodularGallery = function(path){
  try{
    if(!path) return;
    let p = String(path);
    if(!p.startsWith("file:") && !p.startsWith("content:")){
      if(p.startsWith("/")) p = "file://" + p;
      else p = "file:///" + p;
    }
    imagemTemp = p;
    setPreviewFoto(p);
  }catch(e){
    console.log("onKodularGallery erro:", e);
  }
};

/* ===================== CADASTRO ===================== */
function cadastrar(){
  if(!nomeProduto.value || !valorCompra.value) return alert("Preencha tudo");

  estoque.push({
    id: uid("p"),
    nome: nomeProduto.value.trim(),
    compra: +valorCompra.value,
    imagem: imagemTemp || null
  });

  nomeProduto.value = "";
  valorCompra.value = "";
  removerFoto();

  salvarDados();
  atualizarDashboard();
}

/* ===================== VENDA ===================== */
function renderVenda(){
  const vendaDiv = document.getElementById("venda");

  vendaDiv.innerHTML = `
    <div class="card venda-top">
      <input id="buscaVenda" placeholder="Buscar item no estoque‚Ä¶" autocomplete="off" />
      <div class="sub">Use a lixeira no canto do item para excluir do estoque sem vender.</div>
    </div>
    <div id="vendaLista"></div>
  `;

  const lista = document.getElementById("vendaLista");

  if(!estoque.length){
    lista.innerHTML = `<div class="card"><small>Nenhum produto no estoque.</small></div>`;
  }else{
    lista.innerHTML = estoque.map(p => {
      const pid = p.id;
      const nome = escapeHtml(p.nome);
      const compra = Number(p.compra || 0).toFixed(2);
      const img = p.imagem ? p.imagem : "";
      const nomeKey = escapeHtml((p.nome || "").toLowerCase());

      return `
        <div class="produto" data-id="${pid}" data-nome="${nomeKey}">
          <button type="button" class="btn-lixeira" onclick="excluirDoEstoque('${pid}')" aria-label="Excluir do estoque" title="Excluir do estoque">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 6h18"/><path d="M8 6V4h8v2"/><path d="M6 6l1 16h10l1-16"/>
              <path d="M10 11v6"/><path d="M14 11v6"/>
            </svg>
          </button>

          <img src="${img}">
          <div>
            <strong>${nome}</strong><br>
            <small>Custo: R$ ${compra}</small>

            <input type="date" id="data-${pid}">
            <input type="number" placeholder="Valor de venda" id="venda-${pid}" inputmode="decimal">
            <textarea placeholder="Nota / Detalhes" id="nota-${pid}"></textarea>

            <button type="button" class="action" style="background:var(--success)" onclick="vender('${pid}')">Vender</button>
          </div>
        </div>
      `;
    }).join("");
  }

  const busca = document.getElementById("buscaVenda");
  busca.value = vendaFiltro || "";
  busca.addEventListener("input", () => {
    vendaFiltro = busca.value;
    filtrarVendaDOM();
  });

  filtrarVendaDOM();
}

function filtrarVendaDOM(){
  const termo = (vendaFiltro || "").trim().toLowerCase();
  document.querySelectorAll("#vendaLista .produto").forEach(el => {
    const nome = (el.getAttribute("data-nome") || "");
    el.style.display = (!termo || nome.includes(termo)) ? "" : "none";
  });
}

function excluirDoEstoque(id){
  if(!confirm("Excluir este item do estoque?")) return;

  const idx = estoque.findIndex(p => p.id === id);
  if(idx < 0) return;

  estoque.splice(idx, 1);

  salvarDados();
  atualizarDashboard();
  renderVenda();
}

function vender(id){
  const idx = estoque.findIndex(p => p.id === id);
  if(idx < 0) return alert("Item n√£o encontrado.");

  const v = parseFloat(document.getElementById(`venda-${id}`).value);
  if(!v) return alert("Informe o valor da venda");

  const p = estoque[idx];
  const nota = document.getElementById(`nota-${id}`).value;
  const dataInput = document.getElementById(`data-${id}`).value;
  const dataVenda = dataInput ? new Date(dataInput + "T12:00") : new Date();

  lucroTotal += v - p.compra;

  historico.push({
    id: uid("h"),
    produtoId: p.id,
    nome: p.nome,
    compra: p.compra,
    imagem: p.imagem || null,
    venda: v,
    nota: nota || "",
    data: dataVenda.toLocaleDateString("pt-BR"),
    mes: dataVenda.getMonth(),
    ts: dataVenda.getTime()
  });

  estoque.splice(idx, 1);

  salvarDados();
  atualizarDashboard();
  atualizarHistorico();
  renderVenda();
}

/* ===================== DASHBOARD ===================== */
function atualizarDashboard(){
  qtd.textContent = estoque.length;
  valorEstoque.textContent = estoque.reduce((s,p)=>s + Number(p.compra||0), 0).toFixed(2);
  lucro.textContent = Number(lucroTotal || 0).toFixed(2);
}

/* ===================== HIST√ìRICO ===================== */
function atualizarHistorico(){
  const mes = filtroMes.value;
  historicoLista.innerHTML = "";

  const vis = historico
    .slice()
    .sort((a,b)=>b.ts-a.ts)
    .filter(h => mes==="" || String(h.mes) === String(mes));

  if(!vis.length){
    historicoLista.innerHTML = `<small>Nenhuma venda registrada.</small>`;
    return;
  }

  historicoLista.innerHTML = vis.map(h => {
    const hid = h.id;
    const nome = escapeHtml(h.nome);
    const data = escapeHtml(h.data);
    const img = h.imagem ? h.imagem : "";

    return `
      <div class="historico-item">
        <div class="historico-header">
          <img src="${img}">
          <strong onclick="toggleDetalhes('${hid}')">${nome}</strong>
          <div onclick="toggleDetalhes('${hid}')">${data}</div>
          <div class="seta" id="seta-${hid}" onclick="toggleDetalhes('${hid}')">‚ñ∂</div>
        </div>

        <div class="historico-detalhes" id="detalhes-${hid}">
          <p>Compra: R$ ${Number(h.compra||0).toFixed(2)}</p>
          <p>Venda: R$ ${Number(h.venda||0).toFixed(2)}</p>
          <p>Lucro: R$ ${(Number(h.venda||0)-Number(h.compra||0)).toFixed(2)}</p>
          <p>Nota: ${escapeHtml(h.nota || "-")}</p>
          <button type="button" class="action" style="background:var(--danger)" onclick="excluirVenda('${hid}')">Excluir</button>
        </div>
      </div>
    `;
  }).join("");
}

function toggleDetalhes(id){
  const d = document.getElementById(`detalhes-${id}`);
  const s = document.getElementById(`seta-${id}`);
  if(!d || !s) return;

  const aberto = d.style.display === "block";
  d.style.display = aberto ? "none" : "block";
  s.textContent = aberto ? "‚ñ∂" : "‚ñº";
}

function excluirVenda(id){
  if(!confirm("Excluir esta venda?")) return;

  const idx = historico.findIndex(h => h.id === id);
  if(idx < 0) return;

  const h = historico[idx];
  lucroTotal -= (Number(h.venda||0) - Number(h.compra||0));

  historico.splice(idx,1);

  salvarDados();
  atualizarDashboard();
  atualizarHistorico();
}

/* ===================== INIT ===================== */
carregarDados();
setPreviewFoto(null);
</script>
</body>
</html>
