<script>
  const $ = (id) => document.getElementById(id);

  let estoque = [];
  let historico = [];
  let lucroTotal = 0;
  let imagemTemp = null;

  // evita loop quando estiver restaurando do Kodular
  let __restoringFromKodular = false;

  // ===== Base64 seguro (Unicode) =====
  function b64EncodeUnicode(str){
    return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,
      (_, p1) => String.fromCharCode(parseInt(p1, 16))
    ));
  }
  function b64DecodeUnicode(b64){
    return decodeURIComponent(Array.prototype.map.call(atob(b64), c =>
      '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
    ).join(''));
  }

  // ===== Estado completo =====
  function getStateObj(){
    return { estoque, historico, lucroTotal };
  }
  function setStateObj(state){
    estoque = Array.isArray(state.estoque) ? state.estoque : [];
    historico = Array.isArray(state.historico) ? state.historico : [];
    lucroTotal = Number(state.lucroTotal) || 0;
  }

  function enviarParaKodular(){
    if(__restoringFromKodular) return;
    try{
      const json = JSON.stringify(getStateObj());
      const b64  = b64EncodeUnicode(json);

      // Só existe dentro do WebViewer (Kodular/App Inventor)
      if(window.AppInventor && window.AppInventor.setWebViewString){
        window.AppInventor.setWebViewString(b64);
      }
    }catch(e){}
  }

  // ===== STORAGE local + envia para Kodular =====
  function salvarDados(){
    localStorage.setItem("estoque", JSON.stringify(estoque));
    localStorage.setItem("historico", JSON.stringify(historico));
    localStorage.setItem("lucroTotal", String(lucroTotal));
    enviarParaKodular();
  }

  function carregarDados(){
    estoque = JSON.parse(localStorage.getItem("estoque")) || [];
    historico = JSON.parse(localStorage.getItem("historico")) || [];
    lucroTotal = parseFloat(localStorage.getItem("lucroTotal")) || 0;
    atualizarDashboard();
    atualizarHistorico();
  }

  // ===== FUNÇÃO QUE O KODULAR CHAMA =====
  // (via EvaluateJS)
  window.loadFromKodularB64 = function(b64){
    if(!b64) return;
    try{
      __restoringFromKodular = true;

      const json = b64DecodeUnicode(b64);
      const state = JSON.parse(json);

      setStateObj(state);

      // salva no localStorage mas NÃO reenvia pro Kodular (evita loop)
      localStorage.setItem("estoque", JSON.stringify(estoque));
      localStorage.setItem("historico", JSON.stringify(historico));
      localStorage.setItem("lucroTotal", String(lucroTotal));

      atualizarDashboard();
      atualizarHistorico();
    }catch(e){
      console.log("Erro ao restaurar do Kodular:", e);
    }finally{
      __restoringFromKodular = false;
    }
  };

  // ===== NAV =====
  function mostrar(id){
    document.querySelectorAll(".screen").forEach(s => s.classList.add("hidden"));
    $(id).classList.remove("hidden");
    if(id === "venda") renderVenda();
  }

  // ===== IMAGEM (REDUZ PARA NÃO EXPLODIR O TAMANHO) =====
  function carregarImagem(e){
    const file = e.target.files && e.target.files[0];
    if(!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      const img = new Image();
      img.onload = () => {
        const max = 480; // reduz bastante
        let w = img.width, h = img.height;
        if(w > h && w > max){ h = Math.round(h * (max / w)); w = max; }
        else if(h > max){ w = Math.round(w * (max / h)); h = max; }

        const canvas = document.createElement("canvas");
        canvas.width = w;
        canvas.height = h;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, w, h);

        imagemTemp = canvas.toDataURL("image/jpeg", 0.75); // bem menor que PNG
      };
      img.src = reader.result;
    };
    reader.readAsDataURL(file);
  }

  // ===== CADASTRO =====
  function cadastrar(){
    const nome = $("nomeProduto").value.trim();
    const compra = parseFloat($("valorCompra").value);

    if(!nome || !compra) return alert("Preencha tudo");

    estoque.push({ nome, compra, imagem: imagemTemp });

    $("nomeProduto").value = "";
    $("valorCompra").value = "";
    imagemTemp = null;

    salvarDados();
    atualizarDashboard();
    alert("Produto cadastrado!");
  }

  // ===== VENDA =====
  function renderVenda(){
    const vendaEl = $("venda");

    if(estoque.length === 0){
      vendaEl.innerHTML = `<div class="vazio">Nenhum produto no estoque para vender.</div>`;
      return;
    }

    vendaEl.innerHTML = "";

    estoque.forEach((p,i) => {
      vendaEl.innerHTML += `
        <div class="produto">
          <img src="${p.imagem || ''}" alt="">
          <div>
            <strong>${p.nome}</strong>
            <small>Custo: R$ ${p.compra.toFixed(2)}</small>

            <input type="date" id="data-${i}">
            <input type="number" inputmode="decimal" placeholder="Valor de venda" id="venda-${i}">
            <textarea placeholder="Nota / Detalhes" id="nota-${i}"></textarea>

            <button class="action" type="button"
              style="background:var(--success)"
              onclick="vender(${i})">Vender</button>
          </div>
        </div>
      `;
    });
  }

  function vender(i){
    const v = parseFloat(document.getElementById(`venda-${i}`).value);
    if(!v) return alert("Informe o valor de venda");

    const p = estoque[i];
    const nota = document.getElementById(`nota-${i}`).value;
    const dataInput = document.getElementById(`data-${i}`).value;
    const dataVenda = dataInput ? new Date(dataInput + "T12:00") : new Date();

    lucroTotal += (v - p.compra);

    const ts = dataVenda.getTime();
    historico.push({
      ...p,
      venda: v,
      nota,
      data: dataVenda.toLocaleDateString("pt-BR"),
      mes: dataVenda.getMonth(),
      ts
    });

    estoque.splice(i, 1);
    salvarDados();
    renderVenda();
    atualizarDashboard();
    atualizarHistorico();
    alert("Venda registrada!");
  }

  // ===== DASHBOARD =====
  function atualizarDashboard(){
    $("qtd").textContent = estoque.length;
    $("valorEstoque").textContent = estoque.reduce((s,p) => s + p.compra, 0).toFixed(2);
    $("lucro").textContent = lucroTotal.toFixed(2);
  }

  // ===== HISTÓRICO =====
  function atualizarHistorico(){
    const mes = $("filtroMes").value;
    const listaEl = $("historicoLista");
    listaEl.innerHTML = "";

    const lista = historico
      .slice()
      .sort((a,b) => b.ts - a.ts)
      .filter(h => mes === "" || String(h.mes) === String(mes));

    if(lista.length === 0){
      listaEl.innerHTML = `<div class="vazio">Nenhuma venda registrada.</div>`;
      return;
    }

    lista.forEach(h => {
      const key = h.ts;
      listaEl.innerHTML += `
        <div class="historico-item">
          <div class="historico-header">
            <img src="${h.imagem || ''}" alt="">
            <strong onclick="toggleDetalhes(${key})">${h.nome}</strong>
            <div class="data-chip" onclick="toggleDetalhes(${key})">${h.data}</div>
            <div class="seta" id="seta-${key}" onclick="toggleDetalhes(${key})">▶</div>
          </div>

          <div class="historico-detalhes" id="detalhes-${key}">
            <p><b>Compra:</b> R$ ${h.compra.toFixed(2)}</p>
            <p><b>Venda:</b> R$ ${h.venda.toFixed(2)}</p>
            <p><b>Lucro:</b> R$ ${(h.venda - h.compra).toFixed(2)}</p>
            <p><b>Nota:</b> ${h.nota || '-'}</p>
            <button class="action" type="button"
              style="background:var(--danger)"
              onclick="excluirVenda(${key})">Excluir</button>
          </div>
        </div>
      `;
    });
  }

  function toggleDetalhes(key){
    const d = document.getElementById(`detalhes-${key}`);
    const s = document.getElementById(`seta-${key}`);
    const aberto = d.style.display === "block";
    d.style.display = aberto ? "none" : "block";
    s.textContent = aberto ? "▶" : "▼";
  }

  function excluirVenda(key){
    if(!confirm("Excluir esta venda?")) return;

    const idx = historico.findIndex(h => h.ts === key);
    if(idx === -1) return;

    const h = historico[idx];
    lucroTotal -= (h.venda - h.compra);

    historico.splice(idx, 1);
    salvarDados();
    atualizarDashboard();
    atualizarHistorico();
  }

  // INIT
  carregarDados();
  mostrar("dashboard");
</script>
