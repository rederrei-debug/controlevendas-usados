<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Controle de Vendas</title>

<style>
:root{
  --bg:#f4f6f9;
  --card:#ffffff;
  --primary:#2563eb;
  --success:#16a34a;
  --danger:#dc2626;
  --warning:#f59e0b;
  --text:#111827;
  --border:#e5e7eb;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:Segoe UI,Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
}

header{
  padding:20px;
  text-align:center;
  font-size:22px;
  font-weight:bold;
  background:var(--primary);
  color:#fff;
}

/* NAV (ajustado p/ celular: 2x2) */
nav{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  padding:15px;
  max-width:900px;
  margin:auto;
}

nav button{
  flex:1 1 calc(50% - 10px);
  padding:14px;
  border-radius:22px;
  border:none;
  background:var(--primary);
  color:#fff;
  font-weight:700;
  font-size:15px;
  cursor:pointer;
}

.container{
  max-width:900px;
  margin:auto;
  padding:15px;
}

.card{
  background:var(--card);
  border-radius:20px;
  padding:20px;
  border:1px solid var(--border);
  margin-bottom:15px;
}

.hidden{display:none}

input,select,textarea{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:1px solid var(--border);
  margin-bottom:10px;
  font-size:16px;
}

textarea{resize:vertical}

button.action{
  width:100%;
  padding:12px;
  border-radius:14px;
  background:var(--primary);
  color:#fff;
  border:none;
  font-weight:bold;
  font-size:16px;
  cursor:pointer;
}

button.action:disabled{
  opacity:.65;
  cursor:not-allowed;
}

/* DASHBOARD */
.dashboard{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:15px;
}

.stat{
  background:#f9fafb;
  padding:20px;
  border-radius:18px;
  border:1px solid var(--border);
}

.stat span{
  display:block;
  font-size:28px;
  font-weight:900;
  margin-top:8px;
}

.stat:nth-child(1) span{color:var(--warning)}
.stat:nth-child(2) span{color:var(--primary)}
.stat:nth-child(3) span{color:var(--success)}

/* VENDA */
.produto{
  display:grid;
  grid-template-columns:90px 1fr;
  gap:15px;
  border:1px solid var(--border);
  border-radius:18px;
  padding:15px;
  margin-bottom:15px;
  position:relative; /* lixeira */
  background:var(--card);
}

.produto img{
  width:90px;
  height:90px;
  object-fit:cover;
  border-radius:14px;
  background:#e5e7eb;
}

/* Lixeira no card da aba Vender */
.btn-del{
  position:absolute;
  top:10px;
  right:10px;
  width:36px;
  height:36px;
  border:none;
  border-radius:12px;
  background:#fff;
  border:1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
}
.btn-del:active{ transform:scale(0.96); }
.btn-del svg{ width:18px; height:18px; fill:var(--danger); }

/* HIST√ìRICO */
.historico-item{
  border:1px solid var(--border);
  border-radius:18px;
  padding:12px;
  margin-bottom:12px;
  background:var(--card);
}

.historico-header{
  display:grid;
  grid-template-columns:70px 1fr 90px 24px;
  align-items:center;
  gap:6px;
}

.historico-header img{
  width:70px;
  height:70px;
  object-fit:cover;
  border-radius:14px;
}

.seta{
  font-size:18px;
  text-align:center;
  cursor:pointer;
  user-select:none;
}

.historico-detalhes{
  margin-top:10px;
  padding-top:10px;
  border-top:1px dashed var(--border);
  display:none;
}

/* Barra de filtros (Busca + Ordena√ß√£o) */
.filtros{
  display:flex;
  gap:10px;
  align-items:center;
  margin-bottom:10px;
}
.filtros .grow{ flex:1; }
.filtros input, .filtros select{ margin-bottom:0; }

/* Texto quando n√£o tem nada */
.vazio{
  text-align:center;
  padding:18px 10px;
  color:#6b7280;
  font-weight:700;
}

/* MOBILE: dashboard em coluna e cards mais confort√°veis */
@media (max-width: 520px){
  header{padding:16px;font-size:20px}
  .container{padding:12px}
  .card{padding:16px}
  .dashboard{grid-template-columns:1fr}
  .stat span{font-size:34px}
  .historico-header{grid-template-columns:64px 1fr 78px 24px}
  .historico-header img{width:64px;height:64px}

  .filtros{flex-direction:column; align-items:stretch;}
}
</style>
</head>

<body>
<header>üí∞ Controle de Vendas</header>

<nav>
  <button onclick="mostrar('dashboard')">Dashboard</button>
  <button onclick="mostrar('cadastro')">Cadastrar</button>
  <button onclick="mostrar('venda')">Vender</button>
  <button onclick="mostrar('historico')">Hist√≥rico</button>
</nav>

<div class="container">

  <!-- DASHBOARD -->
  <div id="dashboard" class="card screen">
    <div class="dashboard">
      <div class="stat">Produtos em estoque<span id="qtd">0</span></div>
      <div class="stat">Valor em estoque<span>R$ <span id="valorEstoque">0.00</span></span></div>
      <div class="stat">Lucro total<span>R$ <span id="lucro">0.00</span></span></div>
    </div>
  </div>

  <!-- CADASTRO -->
  <div id="cadastro" class="card screen hidden">
    <input id="nomeProduto" placeholder="Nome do produto">
    <input id="valorCompra" type="number" placeholder="Valor de compra">
    <input id="imgInput" type="file" accept="image/*" onchange="carregarImagem(event)">
    <button class="action" id="btnCadastrar" onclick="cadastrar()">Cadastrar Produto</button>
  </div>

  <!-- VENDA -->
  <div id="venda" class="screen hidden"></div>

  <!-- HIST√ìRICO -->
  <div id="historico" class="card screen hidden">

    <!-- Busca no hist√≥rico -->
    <input id="buscaHistorico" placeholder="Buscar no hist√≥rico (nome/nota)" oninput="atualizarHistorico()">

    <div class="filtros">
      <select id="filtroMes" class="grow" onchange="atualizarHistorico()">
        <option value="">Todos os meses</option>
        <option value="0">Janeiro</option><option value="1">Fevereiro</option><option value="2">Mar√ßo</option>
        <option value="3">Abril</option><option value="4">Maio</option><option value="5">Junho</option>
        <option value="6">Julho</option><option value="7">Agosto</option><option value="8">Setembro</option>
        <option value="9">Outubro</option><option value="10">Novembro</option><option value="11">Dezembro</option>
      </select>

      <select id="ordemHistorico" onchange="atualizarHistorico()">
        <option value="recente">Mais recente</option>
        <option value="antigo">Mais antigo</option>
        <option value="lucroMaior">Maior lucro</option>
        <option value="lucroMenor">Menor lucro</option>
      </select>
    </div>

    <div id="historicoLista"></div>
  </div>

</div>

<script>
let estoque = [];
let historico = [];
let lucroTotal = 0;

let imagemTemp = null;
let imagemCarregando = false;

let saveTimer = null;

/* ========= helpers base64 (unicode safe) ========= */
function toB64Unicode(str){
  const bytes = new TextEncoder().encode(str);
  let bin = "";
  bytes.forEach(b => bin += String.fromCharCode(b));
  return btoa(bin);
}
function fromB64Unicode(b64){
  const bin = atob(b64);
  const bytes = Uint8Array.from(bin, c => c.charCodeAt(0));
  return new TextDecoder().decode(bytes);
}

/* ========= normaliza√ß√£o p/ busca ========= */
function norm(txt){
  const s = (txt ?? "").toString().toLowerCase();
  try{
    return s.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
  }catch(e){
    return s;
  }
}

/* ========= comunica√ß√£o com Kodular ========= */
function isKodular(){
  return !!(window.AppInventor && typeof window.AppInventor.setWebViewString === "function");
}

function snapshotObj(updatedAt){
  return {
    v: 1,
    updatedAt: updatedAt || Date.now(),
    estoque,
    historico,
    lucroTotal
  };
}

function exportSnapshotB64(updatedAt){
  return toB64Unicode(JSON.stringify(snapshotObj(updatedAt)));
}

function enviarParaKodularDebounced(updatedAt){
  if(!isKodular()) return;
  clearTimeout(saveTimer);
  saveTimer = setTimeout(() => {
    try{
      const b64 = exportSnapshotB64(updatedAt);
      window.AppInventor.setWebViewString(b64);
    }catch(e){
      console.log("Falha ao enviar para Kodular:", e);
    }
  }, 500);
}

/* Fun√ß√£o chamada pelo Kodular via EvaluateJS */
window.loadFromKodularB64 = function(b64){
  try{
    if(!b64) return;

    const json = fromB64Unicode(b64);
    const data = JSON.parse(json);

    if(!data || typeof data !== "object") return;

    const remoteUpdated = Number(data.updatedAt || 0);
    const localUpdated  = Number(localStorage.getItem("updatedAt") || 0);

    if(localUpdated && remoteUpdated && remoteUpdated <= localUpdated){
      return;
    }

    estoque = Array.isArray(data.estoque) ? data.estoque : [];
    historico = Array.isArray(data.historico) ? data.historico : [];
    lucroTotal = Number(data.lucroTotal || 0);

    try{
      localStorage.setItem("estoque", JSON.stringify(estoque));
      localStorage.setItem("historico", JSON.stringify(historico));
      localStorage.setItem("lucroTotal", String(lucroTotal));
      localStorage.setItem("updatedAt", String(remoteUpdated || Date.now()));
    }catch(e){}

    atualizarDashboard();
    atualizarHistorico();

    if(!document.getElementById("venda").classList.contains("hidden")){
      renderVenda();
    }
  }catch(e){
    console.log("loadFromKodularB64 erro:", e);
  }
};

/* ========= STORAGE ========= */
function salvarDados(){
  const updatedAt = Date.now();

  try{
    localStorage.setItem("estoque", JSON.stringify(estoque));
    localStorage.setItem("historico", JSON.stringify(historico));
    localStorage.setItem("lucroTotal", String(lucroTotal));
    localStorage.setItem("updatedAt", String(updatedAt));
  }catch(e){
    console.log("localStorage cheio/erro:", e);
  }

  enviarParaKodularDebounced(updatedAt);
}

function carregarDados(){
  try{
    estoque = JSON.parse(localStorage.getItem("estoque")) || [];
    historico = JSON.parse(localStorage.getItem("historico")) || [];
    lucroTotal = parseFloat(localStorage.getItem("lucroTotal")) || 0;
  }catch(e){
    estoque = [];
    historico = [];
    lucroTotal = 0;
  }
  atualizarDashboard();
  atualizarHistorico();
}

/* ========= NAV ========= */
function mostrar(id){
  document.querySelectorAll('.screen').forEach(e => e.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  if(id === "venda") renderVenda();
}

/* ========= IMAGEM (compress√£o) ========= */
function carregarImagem(e){
  const file = e.target.files && e.target.files[0];
  if(!file) return;

  imagemCarregando = true;
  document.getElementById("btnCadastrar").disabled = true;

  const r = new FileReader();
  r.onload = () => {
    const img = new Image();
    img.onload = () => {
      const max = 700;
      let w = img.width, h = img.height;
      const scale = Math.min(1, max / Math.max(w, h));
      const cw = Math.round(w * scale);
      const ch = Math.round(h * scale);

      const canvas = document.createElement("canvas");
      canvas.width = cw;
      canvas.height = ch;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, cw, ch);

      imagemTemp = canvas.toDataURL("image/jpeg", 0.75);

      imagemCarregando = false;
      document.getElementById("btnCadastrar").disabled = false;
    };
    img.src = r.result;
  };
  r.readAsDataURL(file);
}

/* ========= ID √∫nico ========= */
function genId(){
  return Date.now().toString(36) + Math.random().toString(36).slice(2,8);
}

/* ========= CADASTRO ========= */
function cadastrar(){
  if(imagemCarregando) return alert("Aguarde a imagem carregar.");
  if(!nomeProduto.value || !valorCompra.value) return alert("Preencha tudo");

  const now = Date.now();

  estoque.push({
    id: genId(),
    createdAt: now,
    nome: nomeProduto.value,
    compra: +valorCompra.value,
    imagem: imagemTemp
  });

  nomeProduto.value = "";
  valorCompra.value = "";
  imagemTemp = null;
  document.getElementById("imgInput").value = "";

  salvarDados();
  atualizarDashboard();

  // se estiver na aba vender, atualiza a lista sem quebrar teclado
  if(!document.getElementById("venda").classList.contains("hidden")){
    updateVendaList();
  }
}

/* =========================================================
   VENDA (corrige teclado sumindo: N√ÉO recria input a cada tecla)
   ========================================================= */
let vendaUIReady = false;
let vendaRefreshTimer = null;

function ensureVendaUI(){
  if(vendaUIReady) return;

  const vendaEl = document.getElementById("venda");
  vendaEl.innerHTML = `
    <div class="card">
      <div class="filtros">
        <input id="buscaVenda" class="grow" placeholder="Buscar no estoque (nome)">
        <select id="ordemVenda">
          <option value="recente">Mais recente</option>
          <option value="antigo">Mais antigo</option>
          <option value="nomeAZ">Nome A-Z</option>
          <option value="nomeZA">Nome Z-A</option>
          <option value="custoMaior">Maior custo</option>
          <option value="custoMenor">Menor custo</option>
        </select>
      </div>
      <div id="listaVenda"></div>
    </div>
  `;

  const inputBusca = document.getElementById("buscaVenda");
  const selectOrdem = document.getElementById("ordemVenda");

  inputBusca.addEventListener("input", () => {
    clearTimeout(vendaRefreshTimer);
    vendaRefreshTimer = setTimeout(updateVendaList, 120);
  });

  selectOrdem.addEventListener("change", () => {
    updateVendaList();
  });

  vendaUIReady = true;
}

function renderVenda(){
  ensureVendaUI();
  updateVendaList();
}

function updateVendaList(){
  const listaEl = document.getElementById("listaVenda");
  if(!listaEl) return;

  const busca = norm((document.getElementById("buscaVenda").value || "").trim());
  const ordem = (document.getElementById("ordemVenda").value || "recente");

  let lista = estoque.slice();

  if(busca){
    lista = lista.filter(p => norm(p.nome).includes(busca));
  }

  lista.sort((a,b)=>{
    const ca = Number(a.createdAt || 0);
    const cb = Number(b.createdAt || 0);
    const na = norm(a.nome);
    const nb = norm(b.nome);
    const pa = Number(a.compra || 0);
    const pb = Number(b.compra || 0);

    switch(ordem){
      case "antigo": return ca - cb;
      case "nomeAZ": return na.localeCompare(nb);
      case "nomeZA": return nb.localeCompare(na);
      case "custoMaior": return pb - pa;
      case "custoMenor": return pa - pb;
      case "recente":
      default: return cb - ca;
    }
  });

  if(lista.length === 0){
    listaEl.innerHTML = `<div class="vazio">Nenhum item encontrado no estoque.</div>`;
    return;
  }

  let html = "";
  lista.forEach(p => {
    const pid = p.id;
    html += `
      <div class="produto">
        <button class="btn-del" title="Excluir produto" onclick="excluirProdutoById('${pid}')">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M9 3h6l1 2h4v2H4V5h4l1-2zm1 6h2v10h-2V9zm4 0h2v10h-2V9zM7 9h2v10H7V9zm-1 12h12a2 2 0 0 0 2-2V9H4v10a2 2 0 0 0 2 2z"/>
          </svg>
        </button>

        <img src="${p.imagem || ''}">
        <div>
          <strong>${p.nome}</strong><br>
          <small>Custo: R$ ${Number(p.compra).toFixed(2)}</small>

          <input type="date" id="data-${pid}">
          <input type="number" placeholder="Valor de venda" id="venda-${pid}">
          <textarea placeholder="Nota / Detalhes" id="nota-${pid}"></textarea>

          <button class="action" style="background:var(--success)" onclick="venderById('${pid}')">Vender</button>
        </div>
      </div>
    `;
  });

  listaEl.innerHTML = html;
}

function excluirProdutoById(id){
  if(!confirm("Excluir este produto do estoque?")) return;

  const idx = estoque.findIndex(p => p.id === id);
  if(idx === -1) return;

  estoque.splice(idx, 1);
  salvarDados();
  atualizarDashboard();
  updateVendaList();
}

function venderById(id){
  const idx = estoque.findIndex(p => p.id === id);
  if(idx === -1) return alert("Produto n√£o encontrado (atualize a tela).");

  const v = parseFloat(document.getElementById(`venda-${id}`).value);
  if(!v) return alert("Informe o valor");

  const p = estoque[idx];
  const nota = document.getElementById(`nota-${id}`).value;
  const dataInput = document.getElementById(`data-${id}`).value;
  const dataVenda = dataInput ? new Date(dataInput + "T12:00") : new Date();

  lucroTotal += v - Number(p.compra);

  historico.push({
    ...p,
    venda: v,
    nota,
    data: dataVenda.toLocaleDateString("pt-BR"),
    mes: dataVenda.getMonth(),
    ts: dataVenda.getTime()
  });

  estoque.splice(idx, 1);

  salvarDados();
  atualizarDashboard();
  atualizarHistorico();
  updateVendaList();
}

/* ========= DASHBOARD ========= */
function atualizarDashboard(){
  qtd.textContent = estoque.length;
  valorEstoque.textContent = estoque.reduce((s,p)=>s+Number(p.compra||0),0).toFixed(2);
  lucro.textContent = lucroTotal.toFixed(2);
}

/* ========= HIST√ìRICO (com busca + ordena√ß√£o) ========= */
function atualizarHistorico(){
  const mes = document.getElementById("filtroMes").value;
  const busca = norm((document.getElementById("buscaHistorico").value || "").trim());
  const ordem = (document.getElementById("ordemHistorico").value || "recente");

  historicoLista.innerHTML = "";

  let lista = historico.slice();

  if(mes !== ""){
    lista = lista.filter(h => String(h.mes) === String(mes));
  }

  if(busca){
    lista = lista.filter(h => {
      const alvo = norm(h.nome) + " " + norm(h.nota || "");
      return alvo.includes(busca);
    });
  }

  lista.sort((a,b)=>{
    const la = (Number(a.venda) - Number(a.compra));
    const lb = (Number(b.venda) - Number(b.compra));

    switch(ordem){
      case "antigo": return Number(a.ts) - Number(b.ts);
      case "lucroMaior": return lb - la;
      case "lucroMenor": return la - lb;
      case "recente":
      default: return Number(b.ts) - Number(a.ts);
    }
  });

  if(lista.length === 0){
    historicoLista.innerHTML = `<div class="vazio">Nenhuma venda encontrada.</div>`;
    return;
  }

  lista.forEach((h)=>{
    const key = h.ts;
    historicoLista.innerHTML += `
      <div class="historico-item">
        <div class="historico-header">
          <img src="${h.imagem||''}">
          <strong onclick="toggleDetalhes(${key})">${h.nome}</strong>
          <div onclick="toggleDetalhes(${key})">${h.data}</div>
          <div class="seta" id="seta-${key}" onclick="toggleDetalhes(${key})">‚ñ∂</div>
        </div>

        <div class="historico-detalhes" id="detalhes-${key}">
          <p>Compra: R$ ${Number(h.compra).toFixed(2)}</p>
          <p>Venda: R$ ${Number(h.venda).toFixed(2)}</p>
          <p>Lucro: R$ ${(Number(h.venda)-Number(h.compra)).toFixed(2)}</p>
          <p>Nota: ${h.nota||'-'}</p>
          <button class="action" style="background:var(--danger)" onclick="excluirVendaByTs(${key})">Excluir</button>
        </div>
      </div>
    `;
  });
}

function toggleDetalhes(key){
  const d = document.getElementById(`detalhes-${key}`);
  const s = document.getElementById(`seta-${key}`);
  if(!d || !s) return;
  const aberto = d.style.display === "block";
  d.style.display = aberto ? "none" : "block";
  s.textContent = aberto ? "‚ñ∂" : "‚ñº";
}

function excluirVendaByTs(ts){
  if(!confirm("Excluir esta venda?")) return;
  const idx = historico.findIndex(h => Number(h.ts) === Number(ts));
  if(idx === -1) return;

  const h = historico[idx];
  lucroTotal -= (Number(h.venda) - Number(h.compra));
  historico.splice(idx, 1);

  salvarDados();
  atualizarDashboard();
  atualizarHistorico();
}

/* INIT */
carregarDados();
</script>

</body>
</html>
