<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Controle de Vendas</title>

<style>
:root{
  --bg:#f4f6f9;
  --card:#ffffff;
  --primary:#2563eb;
  --success:#16a34a;
  --danger:#dc2626;
  --warning:#f59e0b;
  --text:#111827;
  --border:#e5e7eb;
  --muted:#6b7280;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:Segoe UI,Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
}
header{
  padding:20px;
  text-align:center;
  font-size:22px;
  font-weight:800;
  background:var(--primary);
  color:#fff;
}

/* NAV (2x2 p/ celular) */
nav{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  padding:15px;
  max-width:900px;
  margin:auto;
}
nav button{
  flex:1 1 calc(50% - 10px);
  padding:14px;
  border-radius:22px;
  border:none;
  background:var(--primary);
  color:#fff;
  font-weight:800;
  font-size:15px;
}

.container{
  max-width:900px;
  margin:auto;
  padding:15px;
}
.card{
  background:var(--card);
  border-radius:20px;
  padding:20px;
  border:1px solid var(--border);
  margin-bottom:15px;
}

.hidden{display:none}

input,select,textarea{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:1px solid var(--border);
  margin-bottom:10px;
  font-size:16px;
}
textarea{resize:vertical}

button.action{
  width:100%;
  padding:12px;
  border-radius:14px;
  background:var(--primary);
  color:#fff;
  border:none;
  font-weight:900;
  font-size:16px;
}

/* DASHBOARD */
.dashboard{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:15px;
}
.stat{
  background:#f9fafb;
  padding:20px;
  border-radius:18px;
  border:1px solid var(--border);
}
.stat span{
  display:block;
  font-size:28px;
  font-weight:900;
  margin-top:8px;
}
.stat:nth-child(1) span{color:var(--warning)}
.stat:nth-child(2) span{color:var(--primary)}
.stat:nth-child(3) span{color:var(--success)}

/* FOTO (cadastro) */
.foto-wrap{
  display:grid;
  grid-template-columns:120px 1fr;
  gap:12px;
  align-items:stretch;
  margin:10px 0 6px;
}
.foto-preview{
  width:120px;
  height:120px;
  border-radius:16px;
  border:1px dashed var(--border);
  background:#f9fafb;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
  color:var(--muted);
  font-weight:700;
  text-align:center;
  padding:10px;
}
.foto-preview img{
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
}
.foto-actions{
  display:flex;
  flex-direction:column;
  gap:10px;
}
.btn-dark{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:none;
  background:#1f2937;
  color:#fff;
  font-weight:900;
  font-size:16px;
}
.btn-danger{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:none;
  background:var(--danger);
  color:#fff;
  font-weight:900;
  font-size:16px;
}
.hidden-input{display:none}

/* VENDA */
.venda-top{
  padding:14px;
}
#vendaLista{margin-top:12px}

.produto{
  position:relative;
  display:grid;
  grid-template-columns:90px 1fr;
  gap:15px;
  border:1px solid var(--border);
  border-radius:18px;
  padding:15px;
  margin-bottom:15px;
  background:#fff;
}
.produto img{
  width:90px;
  height:90px;
  object-fit:cover;
  border-radius:14px;
  background:#e5e7eb;
}
.produto small{color:var(--muted)}
.trash{
  position:absolute;
  top:10px;
  right:10px;
  width:38px;
  height:38px;
  border-radius:12px;
  border:1px solid var(--border);
  background:#fff;
  cursor:pointer;
  font-size:18px;
}

/* HIST√ìRICO */
.historico-item{
  border:1px solid var(--border);
  border-radius:18px;
  padding:12px;
  margin-bottom:12px;
}
.historico-header{
  display:grid;
  grid-template-columns:70px 1fr 90px 24px;
  align-items:center;
  gap:6px;
}
.historico-header img{
  width:70px;
  height:70px;
  object-fit:cover;
  border-radius:14px;
}
.seta{
  font-size:18px;
  text-align:center;
  cursor:pointer;
}
.historico-detalhes{
  margin-top:10px;
  padding-top:10px;
  border-top:1px dashed var(--border);
  display:none;
}

/* MOBILE */
@media (max-width: 520px){
  header{padding:16px;font-size:20px}
  .container{padding:12px}
  .card{padding:16px}
  .dashboard{grid-template-columns:1fr}
  .stat span{font-size:34px}
  .historico-header{grid-template-columns:64px 1fr 78px 24px}
  .historico-header img{width:64px;height:64px}
  .foto-wrap{grid-template-columns:110px 1fr}
  .foto-preview{width:110px;height:110px}
}
</style>
</head>

<body>
<header>üí∞ Controle de Vendas</header>

<nav>
  <button type="button" onclick="mostrar('dashboard')">Dashboard</button>
  <button type="button" onclick="mostrar('cadastro')">Cadastrar</button>
  <button type="button" onclick="mostrar('venda')">Vender</button>
  <button type="button" onclick="mostrar('historico')">Hist√≥rico</button>
</nav>

<div class="container">

  <!-- DASHBOARD -->
  <div id="dashboard" class="tab card">
    <div class="dashboard">
      <div class="stat">Produtos em estoque<span id="qtd">0</span></div>
      <div class="stat">Valor em estoque<span>R$ <span id="valorEstoque">0.00</span></span></div>
      <div class="stat">Lucro total<span>R$ <span id="lucro">0.00</span></span></div>
    </div>
  </div>

  <!-- CADASTRO -->
  <div id="cadastro" class="tab card hidden">
    <input id="nomeProduto" placeholder="Nome do produto">
    <input id="valorCompra" type="number" inputmode="decimal" placeholder="Valor de compra">

    <!-- inputs escondidos (SEM quadrado com X) -->
    <input id="cameraInput" class="hidden-input" type="file" accept="image/*" capture="environment">
    <input id="galleryInput" class="hidden-input" type="file" accept="image/*">

    <div class="foto-wrap">
      <div class="foto-preview" id="fotoPreview">
        <div id="fotoPlaceholder">Sem foto<br>(opcional)</div>
        <img id="fotoImg" alt="" style="display:none;">
      </div>

      <div class="foto-actions">
        <button type="button" class="btn-dark" onclick="abrirCamera()">üì∑ Tirar foto</button>
        <button type="button" class="btn-dark" onclick="abrirGaleria()">üñºÔ∏è Galeria</button>
        <button type="button" class="btn-danger" onclick="removerFoto()">üßΩ Remover foto</button>
      </div>
    </div>

    <button type="button" class="action" id="btnCadastrar" onclick="cadastrar()">Cadastrar Produto</button>
  </div>

  <!-- VENDA -->
  <div id="venda" class="tab hidden">
    <div class="card venda-top">
      <input id="buscaVenda" placeholder="Pesquisar produto no estoque..." autocomplete="off">
    </div>
    <div id="vendaLista"></div>
  </div>

  <!-- HIST√ìRICO -->
  <div id="historico" class="tab card hidden">
    <select id="filtroMes" onchange="atualizarHistorico()">
      <option value="">Todos os meses</option>
      <option value="0">Janeiro</option><option value="1">Fevereiro</option><option value="2">Mar√ßo</option>
      <option value="3">Abril</option><option value="4">Maio</option><option value="5">Junho</option>
      <option value="6">Julho</option><option value="7">Agosto</option><option value="8">Setembro</option>
      <option value="9">Outubro</option><option value="10">Novembro</option><option value="11">Dezembro</option>
    </select>
    <div id="historicoLista"></div>
  </div>

</div>

<script>
/* =======================
   ESTADO
======================= */
let estoque = [];
let historico = [];
let lucroTotal = 0;

/* imagemTemp fica s√≥ durante o cadastro */
let imagemTemp = null;
let imagemCarregando = false;
let abaAtual = "dashboard";

/* =======================
   Helpers base64 unicode-safe
======================= */
function toB64Unicode(str){
  const bytes = new TextEncoder().encode(str);
  let bin = "";
  bytes.forEach(b => bin += String.fromCharCode(b));
  return btoa(bin);
}
function fromB64Unicode(b64){
  const bin = atob(b64);
  const bytes = Uint8Array.from(bin, c => c.charCodeAt(0));
  return new TextDecoder().decode(bytes);
}

/* =======================
   Kodular bridge (TinyDB)
   -> enviamos DADOS LEVES (sem imagens) p/ n√£o bugar
======================= */
let saveTimer = null;

function isKodular(){
  return !!(window.AppInventor && typeof window.AppInventor.setWebViewString === "function");
}

function liteSnapshotObj(updatedAt){
  // N√ÉO mandamos base64 das imagens pro TinyDB (fica pesado e d√° erro)
  return {
    v: 2,
    updatedAt: updatedAt || Date.now(),
    estoque: estoque.map(p => ({ id:p.id, nome:p.nome, compra:p.compra, imgKey:p.imgKey || null })),
    historico: historico.map(h => ({ ...h, imagem: undefined })), // hist√≥rico j√° usa imgKey tamb√©m
    lucroTotal
  };
}

function exportLiteSnapshotB64(updatedAt){
  return toB64Unicode(JSON.stringify(liteSnapshotObj(updatedAt)));
}

function enviarParaKodularDebounced(updatedAt){
  if(!isKodular()) return;
  clearTimeout(saveTimer);
  saveTimer = setTimeout(() => {
    try{
      const b64 = exportLiteSnapshotB64(updatedAt);
      window.AppInventor.setWebViewString(b64);
    }catch(e){
      console.log("Falha ao enviar para Kodular:", e);
    }
  }, 500);
}

/* Kodular chama isso via EvaluateJS ao abrir (carregar do TinyDB) */
window.loadFromKodularB64 = function(b64){
  try{
    if(!b64) return;

    const json = fromB64Unicode(b64);
    const data = JSON.parse(json);
    if(!data || typeof data !== "object") return;

    const remoteUpdated = Number(data.updatedAt || 0);
    const localUpdated  = Number(localStorage.getItem("updatedAt") || 0);

    // s√≥ aplica se TinyDB for mais novo
    if(localUpdated && remoteUpdated && remoteUpdated <= localUpdated){
      return;
    }

    const est = Array.isArray(data.estoque) ? data.estoque : [];
    const hist = Array.isArray(data.historico) ? data.historico : [];
    const lucro = Number(data.lucroTotal || 0);

    // normaliza/migra
    estoque = est.map(p => ({
      id: p.id || makeId(),
      nome: p.nome || "",
      compra: Number(p.compra || 0),
      imgKey: p.imgKey || null
    }));

    historico = hist.map(h => ({
      ...h,
      id: h.id || makeId(),
      imgKey: h.imgKey || h.imgKey || null
    }));

    lucroTotal = lucro;

    // salva local leve
    try{
      localStorage.setItem("estoque", JSON.stringify(estoque));
      localStorage.setItem("historico", JSON.stringify(historico));
      localStorage.setItem("lucroTotal", String(lucroTotal));
      localStorage.setItem("updatedAt", String(remoteUpdated || Date.now()));
    }catch(e){}

    atualizarDashboard();
    if(abaAtual === "venda") renderVenda();
    atualizarHistorico();
  }catch(e){
    console.log("loadFromKodularB64 erro:", e);
  }
};

/* =======================
   IDs + imagem storage local (separado)
======================= */
function makeId(){
  return "p_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,8);
}

function imgKeyOf(id){ return "img_" + id; }

function setImgLocal(key, dataUrl){
  try{
    localStorage.setItem(key, dataUrl);
    return true;
  }catch(e){
    console.log("Sem espa√ßo para salvar imagem:", e);
    return false;
  }
}
function getImgLocal(key){
  try{ return localStorage.getItem(key); }catch(e){ return null; }
}
function delImgLocal(key){
  try{ localStorage.removeItem(key); }catch(e){}
}

/* =======================
   STORAGE (local + TinyDB)
======================= */
function salvarDados(){
  const updatedAt = Date.now();
  try{
    localStorage.setItem("estoque", JSON.stringify(estoque));
    localStorage.setItem("historico", JSON.stringify(historico));
    localStorage.setItem("lucroTotal", String(lucroTotal));
    localStorage.setItem("updatedAt", String(updatedAt));
  }catch(e){
    console.log("localStorage erro:", e);
  }
  enviarParaKodularDebounced(updatedAt);
}

function carregarDados(){
  try{
    estoque = JSON.parse(localStorage.getItem("estoque")) || [];
    historico = JSON.parse(localStorage.getItem("historico")) || [];
    lucroTotal = parseFloat(localStorage.getItem("lucroTotal")) || 0;
  }catch(e){
    estoque = [];
    historico = [];
    lucroTotal = 0;
  }

  // migra itens antigos que tinham "imagem" dentro do objeto
  estoque = estoque.map(p => {
    if(!p.id) p.id = makeId();
    if(!p.imgKey) p.imgKey = imgKeyOf(p.id);

    if(p.imagem && typeof p.imagem === "string" && p.imagem.startsWith("data:image")){
      // joga pra storage local separada e remove do objeto (pra ficar leve)
      if(!getImgLocal(p.imgKey)){
        setImgLocal(p.imgKey, p.imagem);
      }
      delete p.imagem;
    }
    return p;
  });

  historico = historico.map(h => {
    if(!h.id) h.id = makeId();
    if(!h.imgKey) h.imgKey = imgKeyOf(h.id);
    if(h.imagem && typeof h.imagem === "string" && h.imagem.startsWith("data:image")){
      if(!getImgLocal(h.imgKey)){
        setImgLocal(h.imgKey, h.imagem);
      }
      delete h.imagem;
    }
    return h;
  });

  atualizarDashboard();
  atualizarHistorico();
  salvarDados(); // salva j√° ‚Äúleve‚Äù
}

/* =======================
   NAV + limpeza da busca ao trocar de aba
======================= */
function mostrar(id){
  // se saiu da aba venda, limpa busca
  if(abaAtual === "venda" && id !== "venda"){
    const b = document.getElementById("buscaVenda");
    if(b) b.value = "";
  }

  document.querySelectorAll(".tab").forEach(t => t.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");

  abaAtual = id;

  if(id === "venda"){
    const b = document.getElementById("buscaVenda");
    if(b) b.value = "";
    renderVenda();
  }
}

/* =======================
   FOTO (camera/galeria via HTML, sem Kodular)
======================= */
const cameraInput = document.getElementById("cameraInput");
const galleryInput = document.getElementById("galleryInput");

cameraInput.addEventListener("change", (e) => carregarImagem(e, "camera"));
galleryInput.addEventListener("change", (e) => carregarImagem(e, "gallery"));

function abrirCamera(){
  cameraInput.value = "";
  cameraInput.click();
}
function abrirGaleria(){
  galleryInput.value = "";
  galleryInput.click();
}
function removerFoto(){
  imagemTemp = null;
  atualizarPreviewFoto(null);
}

function atualizarPreviewFoto(dataUrl){
  const img = document.getElementById("fotoImg");
  const ph = document.getElementById("fotoPlaceholder");
  if(dataUrl){
    img.src = dataUrl;
    img.style.display = "block";
    ph.style.display = "none";
  }else{
    img.removeAttribute("src");
    img.style.display = "none";
    ph.style.display = "block";
  }
}

function carregarImagem(e){
  const file = e.target.files && e.target.files[0];
  if(!file) return;

  imagemCarregando = true;
  document.getElementById("btnCadastrar").disabled = true;

  const r = new FileReader();
  r.onload = () => {
    const img = new Image();
    img.onload = () => {
      // compress√£o forte p/ n√£o estourar armazenamento
      const max = 520;      // ‚Üì se quiser ainda mais leve
      const quality = 0.65; // ‚Üì se quiser ainda mais leve

      let w = img.width, h = img.height;
      const scale = Math.min(1, max / Math.max(w, h));
      const cw = Math.round(w * scale);
      const ch = Math.round(h * scale);

      const canvas = document.createElement("canvas");
      canvas.width = cw;
      canvas.height = ch;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, cw, ch);

      imagemTemp = canvas.toDataURL("image/jpeg", quality);
      atualizarPreviewFoto(imagemTemp);

      imagemCarregando = false;
      document.getElementById("btnCadastrar").disabled = false;
    };
    img.src = r.result;
  };
  r.readAsDataURL(file);
}

/* =======================
   CADASTRO
======================= */
function cadastrar(){
  if(imagemCarregando) return alert("Aguarde a imagem carregar.");
  if(!nomeProduto.value || !valorCompra.value) return alert("Preencha tudo");

  const id = makeId();
  const key = imgKeyOf(id);

  // salva imagem local separada (se houver)
  if(imagemTemp){
    const ok = setImgLocal(key, imagemTemp);
    if(!ok){
      alert("Seu armazenamento est√° cheio para fotos. Cadastre sem foto ou diminua a qualidade.");
      // ainda deixa cadastrar sem foto
    }
  }

  estoque.push({
    id,
    nome: nomeProduto.value,
    compra: +valorCompra.value,
    imgKey: imagemTemp ? key : null
  });

  nomeProduto.value = "";
  valorCompra.value = "";
  imagemTemp = null;
  atualizarPreviewFoto(null);

  salvarDados();
  atualizarDashboard();
}

/* =======================
   VENDA + BUSCA + EXCLUIR ITEM DO ESTOQUE (lixeira)
======================= */
document.getElementById("buscaVenda").addEventListener("input", () => {
  // n√£o recria o input -> teclado n√£o some
  renderVendaLista();
});

function renderVenda(){
  renderVendaLista();
}

function renderVendaLista(){
  const busca = (document.getElementById("buscaVenda").value || "").trim().toLowerCase();
  const lista = document.getElementById("vendaLista");
  lista.innerHTML = "";

  const itens = estoque
    .map(p => p)
    .filter(p => !busca || (p.nome || "").toLowerCase().includes(busca));

  if(itens.length === 0){
    lista.innerHTML = `<div class="card"><b>Nenhum item encontrado.</b></div>`;
    return;
  }

  itens.forEach((p) => {
    const imgData = p.imgKey ? getImgLocal(p.imgKey) : null;

    lista.innerHTML += `
      <div class="produto">
        <button type="button" class="trash" onclick="excluirDoEstoque('${p.id}')">üóëÔ∏è</button>
        <img src="${imgData || ''}">
        <div>
          <strong>${escapeHtml(p.nome)}</strong><br>
          <small>Custo: R$ ${Number(p.compra||0).toFixed(2)}</small>
          <input type="date" id="data-${p.id}">
          <input type="number" inputmode="decimal" placeholder="Valor de venda" id="venda-${p.id}">
          <textarea placeholder="Nota / Detalhes" id="nota-${p.id}"></textarea>
          <button type="button" class="action" style="background:var(--success)" onclick="vender('${p.id}')">Vender</button>
        </div>
      </div>`;
  });
}

function excluirDoEstoque(id){
  const idx = estoque.findIndex(p => p.id === id);
  if(idx < 0) return;
  if(!confirm("Excluir este item do estoque?")) return;

  const p = estoque[idx];
  if(p.imgKey) delImgLocal(p.imgKey);

  estoque.splice(idx,1);
  salvarDados();
  atualizarDashboard();
  renderVendaLista();
}

/* =======================
   VENDER
======================= */
function vender(id){
  const idx = estoque.findIndex(p => p.id === id);
  if(idx < 0) return;

  const v = parseFloat(document.getElementById(`venda-${id}`).value);
  if(!v) return alert("Informe o valor");

  const p = estoque[idx];
  const nota = document.getElementById(`nota-${id}`).value;
  const dataInput = document.getElementById(`data-${id}`).value;
  const dataVenda = dataInput ? new Date(dataInput + "T12:00") : new Date();

  lucroTotal += v - p.compra;

  historico.push({
    id: makeId(),
    nome: p.nome,
    compra: Number(p.compra||0),
    venda: v,
    nota,
    data: dataVenda.toLocaleDateString("pt-BR"),
    mes: dataVenda.getMonth(),
    ts: dataVenda.getTime(),
    imgKey: p.imgKey || null
  });

  estoque.splice(idx,1);

  salvarDados();
  atualizarDashboard();
  atualizarHistorico();
  renderVendaLista();
}

/* =======================
   DASHBOARD
======================= */
function atualizarDashboard(){
  qtd.textContent = estoque.length;
  valorEstoque.textContent = estoque.reduce((s,p)=>s+Number(p.compra||0),0).toFixed(2);
  lucro.textContent = lucroTotal.toFixed(2);
}

/* =======================
   HIST√ìRICO
======================= */
function atualizarHistorico(){
  const mes = filtroMes.value;
  historicoLista.innerHTML = "";

  historico
    .slice()
    .sort((a,b)=>b.ts-a.ts)
    .filter(h => mes==="" || h.mes==mes)
    .forEach((h,i)=>{
      const imgData = h.imgKey ? getImgLocal(h.imgKey) : null;

      historicoLista.innerHTML += `
        <div class="historico-item">
          <div class="historico-header">
            <img src="${imgData || ''}">
            <strong onclick="toggleDetalhes(${i})">${escapeHtml(h.nome)}</strong>
            <div onclick="toggleDetalhes(${i})">${h.data}</div>
            <div class="seta" id="seta-${i}" onclick="toggleDetalhes(${i})">‚ñ∂</div>
          </div>
          <div class="historico-detalhes" id="detalhes-${i}">
            <p>Compra: R$ ${Number(h.compra||0).toFixed(2)}</p>
            <p>Venda: R$ ${Number(h.venda||0).toFixed(2)}</p>
            <p>Lucro: R$ ${(Number(h.venda||0)-Number(h.compra||0)).toFixed(2)}</p>
            <p>Nota: ${escapeHtml(h.nota || "-")}</p>
            <button type="button" class="action" style="background:var(--danger)" onclick="excluirVenda(${i})">Excluir</button>
          </div>
        </div>`;
    });
}

function toggleDetalhes(i){
  const d = document.getElementById(`detalhes-${i}`);
  const s = document.getElementById(`seta-${i}`);
  const aberto = d.style.display === "block";
  d.style.display = aberto ? "none" : "block";
  s.textContent = aberto ? "‚ñ∂" : "‚ñº";
}

function excluirVenda(i){
  if(!confirm("Excluir esta venda?")) return;
  const h = historico[i];
  lucroTotal -= (Number(h.venda||0) - Number(h.compra||0));
  historico.splice(i,1);
  salvarDados();
  atualizarDashboard();
  atualizarHistorico();
}

/* =======================
   Utils
======================= */
function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* INIT */
carregarDados();
</script>
</body>
</html>
